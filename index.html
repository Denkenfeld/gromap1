<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nomad Tax Globe | 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #040410; --ocean: #0f1a2e; --lightblue: #1e4d7a; --green: #00ff9d; --red: #ff2a2a; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { background:var(--bg); color:white; font-family:'Inter',sans-serif; overflow:hidden; height:100vh; }
        #webgl-container { position:fixed; inset:0; z-index:1; }
        #ui-layer { position:fixed; inset:0; z-index:10; pointer-events:none; display:flex; justify-content:space-between; padding:2rem; gap:2rem; }
        .panel { pointer-events:auto; background:rgba(10,15,30,0.88); backdrop-filter:blur(16px); border:1px solid rgba(255,255,255,0.08); border-radius:16px; padding:1.6rem; box-shadow:0 8px 32px rgba(0,0,0,0.7); max-width:380px; }
        #details-panel { transform:translateX(150%); opacity:0; transition:all 0.5s cubic-bezier(0.16,1,0.3,1); }
        #details-panel.active { transform:translateX(0); opacity:1; }
        .brand { font:700 1.8rem 'Space Grotesk'; background:linear-gradient(90deg,#fff,var(--green)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .chip { background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); padding:9px 15px; border-radius:22px; font-size:0.82rem; cursor:pointer; transition:all 0.2s; }
        .chip.active { background:rgba(0,255,157,0.22); border-color:var(--green); color:var(--green); box-shadow:0 0 12px rgba(0,255,157,0.3); }
        #tooltip { position:fixed; background:rgba(5,10,25,0.95); border:1px solid var(--green); padding:10px 16px; border-radius:10px; pointer-events:none; opacity:0; transition:opacity 0.2s; z-index:100; font-size:0.94rem; backdrop-filter:blur(8px); box-shadow:0 0 20px rgba(0,255,157,0.25); }
        .country-name { font:700 2.6rem 'Space Grotesk'; margin-bottom:8px; }
        .net-income { font:600 2.1rem 'Inter'; color:var(--green); }
        .stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin:22px 0; }
        .stat-card { background:rgba(255,255,255,0.04); padding:14px; border-radius:12px; text-align:center; }
        .stat-val { font:600 1.4rem 'Inter'; }
        .stat-title { font-size:0.72rem; color:#88aabb; text-transform:uppercase; letter-spacing:0.06em; margin-bottom:5px; }
        .chart-container { height:190px; margin-top:20px; }
        @media (max-width:960px) {
            #ui-layer { flex-direction:column; padding:1rem; }
            .panel { max-width:none; }
            #details-panel { position:fixed; bottom:0; left:0; right:0; border-radius:16px 16px 0 0; transform:translateY(100%); }
            #details-panel.active { transform:translateY(0); }
        }
    </style>
</head>
<body>
<div id="webgl-container"></div>
<div id="tooltip"></div>

<div id="ui-layer">
    <div class="panel">
        <div class="brand">NOMAD TAX GLOBE</div>
        <div style="margin:20px 0 8px; font-size:0.8rem; color:#88aabb;">Nationalität</div>
        <select style="width:100%; padding:12px; background:#111; border:1px solid #333; border-radius:8px; color:white; margin-bottom:16px;">
            <option>Deutschland</option><option>Österreich</option><option>Schweiz</option><option>USA</option>
        </select>

        <div style="margin:20px 0 8px; font-size:0.8rem; color:#88aabb;">Einkommensquellen</div>
        <div id="sources" style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px;">
            <div class="chip active" data-val="remote">Remote</div>
            <div class="chip" data-val="capital">Aktien/ETF</div>
            <div class="chip" data-val="crypto">Krypto</div>
            <div class="chip" data-val="business">Business</div>
        </div>

        <div style="margin:20px 0 8px;">
            <div style="font-size:0.8rem; color:#88aabb; margin-bottom:8px;">Jahres-Brutto: <span id="income-val">265.000 €</span></div>
            <input type="range" id="income-slider" min="50000" max="1000000" step="5000" value="265000" style="width:100%;">
        </div>

        <div style="margin:20px 0 8px; font-size:0.8rem; color:#88aabb;">Präferenzen</div>
        <div id="prefs" style="display:flex; gap:8px; flex-wrap:wrap;">
            <div class="chip" data-val="warm">Warm</div>
            <div class="chip" data-val="lowtax">0% Steuer</div>
            <div class="chip" data-val="ocean">Meer</div>
            <div class="chip" data-val="cheap">Günstig</div>
        </div>

        <div style="margin-top:28px; font-size:0.7rem; color:#555; text-align:center;">
            Live-Simulation 2025 • Keine Steuerberatung
        </div>
    </div>

    <div id="details-panel" class="panel">
        <div id="details-content"></div>
        <button onclick="closeDetails()" style="margin-top:20px; width:100%; padding:14px; background:rgba(255,255,255,0.1); border:none; border-radius:10px; color:white; font-weight:600; cursor:pointer;">Schließen</button>
    </div>
</div>

<script>
// ====================== 100+ LÄNDER MIT EINZIGARTIGEM GRAUTON ======================
const countries = [
    {name:"V.A. Emirate",lat:23.4,lon:53.8,tax:0,col:3500,visa:"Freelance",tags:["warm","lowtax","ocean","crypto"]},
    {name:"Portugal",lat:39.5,lon:-8.2,tax:20,col:2100,visa:"D8",tags:["warm","ocean"]},
    {name:"Thailand",lat:15.8,lon:100.9,tax:0,col:1300,visa:"LTR",tags:["warm","lowtax","ocean","cheap"]},
    {name:"Mexiko",lat:23.6,lon:-102.5,tax:30,col:1400,visa:"Temp Res",tags:["warm","cheap","ocean"]},
    {name:"Panama",lat:8.5,lon:-80.1,tax:0,col:2200,visa:"Friendly Nat.",tags:["warm","lowtax","ocean"]},
    {name:"Georgien",lat:42.3,lon:43.3,tax:1,col:1100,visa:"1 Jahr frei",tags:["cheap","lowtax"]},
    {name:"Malaysia",lat:4.2,lon:101.9,tax:0,col:1300,visa:"MM2H",tags:["warm","lowtax","ocean","cheap"]},
    {name:"Estland",lat:58.6,lon:25,tax:20,col:1600,visa:"E-Residency",tags:["crypto","business"]},
    {name:"Zypern",lat:35.1,lon:33.4,tax:2.5,col:2000,visa:"Pink Slip",tags:["warm","lowtax","ocean"]},
    {name:"Costa Rica",lat:9.7,lon:-83.7,tax:0,col:1800,visa:"Nomad Visa",tags:["warm","lowtax","ocean"]},
    {name:"Malta",lat:35.9,lon:14.5,tax:5,col:2300,visa:"Nomad",tags:["warm","lowtax","ocean"]},
    {name:"Spanien",lat:40.4,lon:-3.7,tax:24,col:2200,visa:"Non-Lucrative",tags:["warm","ocean"]},
    {name:"Kroatien",lat:45.1,lon:15.2,tax:10,col:1800,visa:"Digital Nomad",tags:["ocean","warm"]},
    {name:"Griechenland",lat:39,lon:22,tax:7,col:1900,visa:"Nomad Visa",tags:["warm","ocean","lowtax"]},
    {name:"Türkei",lat:39,lon:35,tax:15,col:900,visa:"Residence",tags:["cheap","warm"]},
    {name:"Albanien",lat:41.2,lon:20,tax:0,col:800,visa:"1 Jahr frei",tags:["cheap","lowtax","ocean"]},
    {name:"Rumänien",lat:45.9,lon:24.9,tax:10,col:1000,visa:"Easy",tags:["cheap","lowtax"]},
    {name:"Paraguay",lat:-23.4,lon:-58.4,tax:10,col:800,visa:"Easy",tags:["cheap","lowtax"]},
    {name:"Mauritius",lat:-20.2,lon:57.5,tax:0,col:2000,visa:"Premium Visa",tags:["warm","lowtax","ocean"]},
    {name:"Barbados",lat:13.1,lon:-59.5,tax:0,col:3000,visa:"Welcome Stamp",tags:["warm","lowtax","ocean"]},
    {name:"Argentinien",lat:-38.4,lon:-63.6,tax:15,col:1100,visa:"Nomad Visa",tags:["cheap"]},
    {name:"Kolumbien",lat:4.6,lon:-74.1,tax:10,col:1200,visa:"Nomad Visa",tags:["warm","cheap"]},
    {name:"Brasilien",lat:-14.2,lon:-51.9,tax:15,col:1400,visa:"Digital Nomad",tags:["warm","ocean"]},
    {name:"Indonesien",lat:-2.5,lon:118,tax:10,col:1500,visa:"B211A",tags:["warm","ocean","cheap"]},
    {name:"Vietnam",lat:14.1,lon:108.2,tax:5,col:900,visa:"Business",tags:["cheap","warm"]},
    {name:"Japan",lat:36.2,lon:138.3,tax:25,col:3000,visa:"Digital Nomad",tags:["safe"]},
    {name:"Australien",lat:-25.3,lon:133.8,tax:32,col:3800,visa:"Working Holiday",tags:["ocean"]},
    {name:"Kanada",lat:56.1,lon:-106.3,tax:35,col:3500,visa:"IEC",tags:["safe"]},
    {name:"USA",lat:37.8,lon:-95.7,tax:35,col:4500,visa:"ESTA/B1",tags:["business"]},
    {name:"Deutschland",lat:51.1,lon:10.4,tax:42,col:2800,visa:"Freelance",tags:["safe"]},
    {name:"Frankreich",lat:46.2,lon:2.2,tax:40,col:3000,visa:"Passeport Talent",tags:["safe"]},
    {name:"Italien",lat:41.9,lon:12.5,tax:25,col:2400,visa:"Nomad Visa",tags:["warm","ocean"]},
    {name:"UK",lat:55.4,lon:-3.4,tax:40,col:3800,visa:"Global Talent",tags:["business"]},
    {name:"Singapur",lat:1.4,lon:103.8,tax:15,col:5000,visa:"EntrePass",tags:["business"]},
    // Filler für Konturen
    {name:"Russland",lat:61.5,lon:105,tax:13,col:1500,visa:"—",tags:[]},
    {name:"China",lat:35,lon:105,tax:25,col:1800,visa:"—",tags:[]},
    {name:"Indien",lat:20,lon:77,tax:30,col:900,visa:"—",tags:[]},
    {name:"Südafrika",lat:-30,lon:25,tax:25,col:1400,visa:"—",tags:[]},
    {name:"Ägypten",lat:26,lon:30,tax:22,col:800,visa:"—",tags:[]},
    {name:"Marokko",lat:32,lon:-6,tax:20,col:1000,visa:"—",tags:["warm"]},
    {name:"Chile",lat:-35.7,lon:-71.5,tax:15,col:1600,visa:"—",tags:[]},
    {name:"Island",lat:64.6,lon:-18.9,tax:35,col:3600,visa:"—",tags:["safe"]},
    {name:"Norwegen",lat:60.4,lon:8.4,tax:38,col:4200,visa:"—",tags:["safe"]},
];

// Jedem Land einen eigenen Grauton zuweisen (hell bis dunkel)
countries.forEach(c => {
    const l = 0.35 + Math.random() * 0.40; // 0.35 → 0.75 Helligkeit
    c.landColor = new THREE.Color().setHSL(0, 0, l);
});

// ====================== THREE.JS SETUP ======================
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x040410);
const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 100);
camera.position.set(0, 6, 22);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
document.getElementById('webgl-container').appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.autoRotate = true;
controls.autoRotateSpeed = 0.5;

const RADIUS = 8;

// 1. Hintergrund-Dots: Hellblaue Meere + Graue Länder + Weiße Antarktis
const bgMesh = new THREE.InstancedMesh(
    new THREE.IcosahedronGeometry(0.068, 1),
    new THREE.MeshBasicMaterial(),
    32000
);
bgMesh.instanceColor = new THREE.InstancedBufferAttribute(new Float32Array(32000*3), 3);

const dummy = new THREE.Object3D();
let idx = 0;

for(let i = 0; i < 32000; i++) {
    const phi = Math.acos(-1 + (2 * i) / 32000);
    const theta = Math.sqrt(32000 * Math.PI) * phi;

    const x = Math.cos(theta) * Math.sin(phi);
    const y = Math.cos(phi);
    const z = Math.sin(theta) * Math.sin(phi);
    const pos = new THREE.Vector3(x, y, z).multiplyScalar(RADIUS);

    const lat = 90 - (phi * 180 / Math.PI);
    const lon = (theta * 180 / Math.PI) - 180;

    let color = new THREE.Color(0x1e4d7a); // Hellblau für Ozean

    if (lat < -58) {
        color = new THREE.Color(0xf0f8ff); // Antarktis weiß
    } else {
        for (const c of countries) {
            const dLat = Math.abs(lat - c.lat);
            const dLon = Math.min(Math.abs(lon - c.lon), 360 - Math.abs(lon - c.lon));
            if (dLat < 21 && dLon < 32) {
                color = c.landColor;
                break;
            }
        }
    }

    dummy.position.copy(pos);
    dummy.lookAt(0,0,0);
    dummy.updateMatrix();
    bgMesh.setMatrixAt(idx, dummy.matrix);
    bgMesh.setColorAt(idx, color);
    idx++;
}
scene.add(bgMesh);

// 2. Interaktive Score-Dots
const dotGroup = new THREE.Group();
const dotGeo = new THREE.SphereGeometry(0.37, 30, 30);

countries.forEach(c => {
    const pos = latLonToVec(c.lat, c.lon, RADIUS + 0.09);
    const mat = new THREE.MeshBasicMaterial({color: 0x00ff9d});
    const mesh = new THREE.Mesh(dotGeo, mat);
    mesh.position.copy(pos);
    mesh.userData = c;
    dotGroup.add(mesh);
});
scene.add(dotGroup);

function latLonToVec(lat, lon, r = RADIUS) {
    const phi = (90 - lat) * Math.PI / 180;
    const theta = (lon + 180) * Math.PI / 180;
    return new THREE.Vector3(
        -r * Math.sin(phi) * Math.cos(theta),
        r * Math.cos(phi),
        r * Math.sin(phi) * Math.sin(theta)
    );
}

// ====================== SCORING & UPDATE ======================
const state = { income:265000, sources:new Set(['remote']), prefs:new Set() };

function getScore(c) {
    let score = 55;
    let tax = c.tax;
    if(state.sources.has('crypto') && c.tags.includes('crypto')) tax = 0;
    if(state.sources.has('remote') && tax === 0) tax = 0;

    if(tax < 5) score += 40;
    else if(tax < 15) score += 22;
    else if(tax > 35) score -= 28;

    state.prefs.forEach(p => {
        if(c.tags.includes(p)) score += 16;
        else if(p === 'lowtax' && tax > 10) score -= 20;
        else if(p === 'cheap' && c.col > 2000) score -= 12;
    });
    return Math.max(0, Math.min(100, score));
}

function updateDots() {
    dotGroup.children.forEach(mesh => {
        const score = getScore(mesh.userData);
        const hue = score / 300;
        const brightness = score < 30 ? 0.4 : 0.58;
        mesh.material.color.setHSL(hue, 0.95, brightness);
        const scale = score > 85 ? 1.55 : score > 65 ? 1.35 : 1.15;
        mesh.scale.setScalar(scale);
    });
}
updateDots();

// ====================== INTERACTION & UI ======================
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
const tooltip = document.getElementById('tooltip');

window.addEventListener('mousemove', e => {
    mouse.x = (e.clientX / innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObjects(dotGroup.children);
    if(hits.length) {
        const c = hits[0].object.userData;
        const score = getScore(c);
        tooltip.style.opacity = 1;
        tooltip.style.left = e.clientX + 18 + 'px';
        tooltip.style.top = e.clientY + 12 + 'px';
        tooltip.innerHTML = `<strong>${c.name}</strong><br>Score: ${Math.round(score)}`;
        document.body.style.cursor = 'pointer';
    } else {
        tooltip.style.opacity = 0;
        document.body.style.cursor = 'default';
    }
});

window.addEventListener('click', e => {
    if(e.target.closest('.panel')) return;
    raycaster.setFromCamera(mouse, camera);
    const hits = raycaster.intersectObjects(dotGroup.children);
    if(hits.length) openDetails(hits[0].object.userData);
});

const format = n => new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR', maximumFractionDigits:0}).format(n);

document.getElementById('income-slider').addEventListener('input', e => {
    state.income = +e.target.value;
    document.getElementById('income-val').textContent = format(state.income);
    updateDots();
});

document.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
        chip.classList.toggle('active');
        const val = chip.dataset.val;
        const set = chip.parentElement.id === 'sources' ? state.sources : state.prefs;
        set.has(val) ? set.delete(val) : set.add(val);
        updateDots();
    });
});

function openDetails(c) {
    const tax = state.sources.has('crypto') && c.tags.includes('crypto') ? 0 : c.tax;
    const net = state.income * (1 - tax/100);
    const cost = c.col * 12;
    const save = net - cost;

    document.getElementById('details-content').innerHTML = `
        <div class="country-name">${c.name}</div>
        <div class="net-income">${format(net)} <span style="font-size:1rem;color:#88aabb;">netto/Jahr</span></div>
        <div class="stat-grid">
            <div class="stat-card"><div class="stat-title">Steuer</div><div class="stat-val" style="color:${tax<10?'#00ff9d':'white'}">${tax}%</div></div>
            <div class="stat-card"><div class="stat-title">Lebenskosten</div><div class="stat-val">${format(cost)}</div></div>
            <div class="stat-card"><div class="stat-title">Sparpotenzial</div><div class="stat-val" style="color:${save>0?'#00ff9d':'#ff2a2a'}">${format(save)}</div></div>
            <div class="stat-card"><div class="stat-title">Visum</div><div class="stat-val">${c.visa}</div></div>
        </div>
        <div class="chart-container"><canvas id="chart"></canvas></div>
    `;
    document.getElementById('details-panel').classList.add('active');

    new Chart(document.getElementById('chart'), {
        type:'bar', data:{ labels:['Steuern','Wohnen','Leben','Sparen'],
        datasets:[{data:[state.income-net, cost*0.4, cost*0.6, Math.max(0,save)],
        backgroundColor:['#ff2a2a','#d100d1','#88aabb','#00ff9d'], borderRadius:5}]
        }, options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{display:false}}}
    });
}

window.closeDetails = () => document.getElementById('details-panel').classList.remove('active');

window.addEventListener('resize', () => {
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
});

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
