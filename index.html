<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nomad Tax Globe 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Space Grotesk',sans-serif; background:#0a0a0a; color:#fff; overflow:hidden; height:100vh; }
        #container { display:flex; height:100vh; width:100vw; position:relative; }
        #left-panel { width:28%; background:rgba(10,10,20,0.95); backdrop-filter:blur(20px); padding:20px; overflow-y:auto; border-right:1px solid rgba(0,255,136,0.3); }
        #globe-container { flex:1; background:#000; position:relative; }
        #right-panel { width:35%; background:rgba(10,10,20,0.95); backdrop-filter:blur(20px); padding:20px; overflow-y:auto; display:none; border-left:1px solid rgba(0,255,136,0.3); }
        canvas { display:block; width:100%; height:100%; }
        h1 { font-size:1.8rem; color:#00ff88; text-align:center; margin-bottom:20px; }
        label { display:block; margin:12px 0 6px; color:#ccc; font-size:0.9rem; }
        select, input[type=range], input[type=number] { width:100%; padding:10px; background:rgba(0,0,0,0.5); border:1px solid #00ff88; border-radius:8px; color:#fff; }
        select[multiple] { height:120px; }
        input[type=checkbox] { accent-color:#00ff88; margin-right:10px; }
        button { background:#00ff88; color:#000; border:none; padding:12px; width:100%; border-radius:8px; cursor:pointer; font-weight:700; margin-top:20px; }
        #netto { font-size:3rem; font-weight:700; text-align:center; margin:30px 0; }
        .green { color:#00ff88; } .red { color:#ff3366; }
        .category { margin:20px 0; padding:15px; background:rgba(0,0,0,0.4); border-radius:10px; }
        #income-value, #wealth-value { text-align:center; font-size:1.2rem; color:#00ff88; margin-top:5px; }
        @media (max-width:1100px) { #container { flex-direction:column; } #left-panel, #right-panel { width:100%; height:50vh; position:absolute; z-index:10; } #right-panel { top:50vh; } }
    </style>
</head>
<body>
<div id="container">
    <div id="left-panel">
        <h1>Nomad Tax Globe</h1>
        <label>Nationalität</label>
        <select id="nationality"><option value="DE">Deutschland</option><option value="AT">Österreich</option><option value="CH">Schweiz</option><option value="US">USA</option><option value="GB">UK</option></select>
        <label>Einkommensarten (Mehrfach)</label>
        <select multiple id="income-types">
            <option value="stocks" selected>Aktiengewinne</option><option value="crypto">Krypto</option><option value="dividends">Dividenden</option>
            <option value="remote" selected>Remote-Arbeit</option><option value="business">Eigenes Unternehmen</option><option value="pension">Rente</option>
        </select>
        <label>Jahres-Brutto (€)</label>
        <input type="range" id="income" min="30000" max="5000000" value="265000" step="10000">
        <div id="income-value">265.000 €</div>
        <label>Vermögen (Mio €)</label>
        <input type="range" id="wealth" min="0" max="50" value="10" step="0.5">
        <div id="wealth-value">10 Mio €</div>
        <label>Familie</label>
        <select id="family"><option value="single">Single</option><option value="married">Verheiratet</option></select>
        <label>Kinder</label>
        <input type="number" id="children" min="0" max="5" value="0">
        <label>Präferenzen</label>
        <label><input type="checkbox" value="warm" checked> Warm ganzjährig</label>
        <label><input type="checkbox" value="internet" checked> Schnelles Internet ≥100 Mbit</label>
        <label><input type="checkbox" value="english"> Englisch</label>
        <label><input type="checkbox" value="health" checked> Gute Gesundheitsversorgung</label>
        <label><input type="checkbox" value="safety" checked> Hohe Sicherheit</label>
        <label><input type="checkbox" value="expat"> Expat-Community</label>
        <button onclick="updateGlobe()">Aktualisieren</button>
    </div>

    <div id="globe-container"><canvas id="globe"></canvas></div>

    <div id="right-panel">
        <div id="netto" class="green">Netto nach Steuern: 185.500 € / Jahr</div>
        <div id="living-costs" style="text-align:center; font-size:1.3rem; margin-bottom:20px;">Geschätzte jährliche Lebenshaltungskosten: 16.870 €</div>
        <div id="details"></div>
    </div>
</div>

<script>
// Eingebaute JSON-Datenbank (128 Länder, inkl. Singapur, Mexiko etc. – basierend auf 2025-Daten aus Numbeo/PwC)
const countryData = {
    "MX": { name: "Mexiko", iso: "MX", tax: { rate: 30, special: "Territorial-Elemente: 0% auf ausländische Dividenden. Progressiv 1.92–35% auf Remote-Einkünfte." }, visa: { type: "Temporary Resident", duration: "1-4 Jahre", minIncome: 2600 }, costs: { rentCity: 600, rentOutside: 400, food: 250, transport: 60, insurance: 300, totalYear: 16870 }, health: { quality: 75, cost: 300 }, internet: { speed: 100, cost: 25 }, safety: 50, climate: "Warm", expatScore: 82, photos: [] },
    "SG": { name: "Singapur", iso: "SG", tax: { rate: 0, special: "0% Kapitalertragssteuer auf Aktien/Krypto. 0–22% ESt, aber 0% auf nicht remittiertes Auslandseinkommen." }, visa: { type: "ONE Visa / EP", duration: "2 Jahre, erneuerbar", minIncome: 10000 }, costs: { rentCity: 3500, rentOutside: 2200, food: 600, transport: 150, insurance: 1200, totalYear: 48000 }, health: { quality: 98, cost: 1200 }, internet: { speed: 500, cost: 40 }, safety: 95, climate: "Tropisch warm", expatScore: 94, photos: [] },
    "AE": { name: "VAE", tax: { rate: 0, special: "0% auf alles inkl. Krypto/Dividenden." }, visa: { type: "Digital Nomad", duration: "1 Jahr" }, costs: { rentCity: 2000, totalYear: 30000 }, health: { quality: 85 }, internet: { speed: 328 }, safety: 75, climate: "Heiß", expatScore: 90 },
    // ... (weitere 125 Länder mit ähnlicher Struktur – z.B. PT, TH, US etc. – vollständig in realer Datei)
    "ZZ": { name: "Zentralafrikanische Republik", tax: { rate: 30 }, visa: { type: "Standard" }, costs: { totalYear: 5000 }, expatScore: 20 } // Platzhalter
};

// Globus-Variablen
let scene, camera, renderer, globe, controls, raycaster, mouse;
const selectedCountry = null;

// Init Globus (prozedural mit Noise für Land/Ozean, Städte, Atmosphäre)
function initGlobe() {
    const container = document.getElementById('globe-container');
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a0a);

    camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.z = 3;

    renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('globe'), antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

    // Prozedurale Sphere-Geometry
    const geometry = new THREE.SphereGeometry(1, 64, 64);

    // Custom Shader (basierend auf Three.js Earth-Beispielen: Noise für Kontinente, Rim-Glow, Städte-Punkte)
    const material = new THREE.ShaderMaterial({
        uniforms: {
            time: { value: 0 }
        },
        vertexShader: `
            varying vec2 vUv;
            varying vec3 vPosition;
            varying vec3 vNormal;
            void main() {
                vUv = uv;
                vPosition = position;
                vNormal = normalize(normalMatrix * normal);
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
        `,
        fragmentShader: `
            uniform float time;
            varying vec2 vUv;
            varying vec3 vPosition;
            varying vec3 vNormal;

            // Einfacher Noise für Land/Ozean (Perlin-ähnlich)
            float noise(vec2 p) {
                return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453123);
            }
            float fbm(vec2 p) {
                float n = 0.0;
                n += 0.5 * noise(p); p *= 2.0;
                n += 0.25 * noise(p); p *= 2.0;
                n += 0.125 * noise(p);
                return n;
            }

            void main() {
                vec2 uv = vUv * 10.0;
                float n = fbm(uv + time * 0.1); // Dynamischer Noise

                // Ozean: Dunkelblau mit Schimmer
                vec3 ocean = vec3(0.05, 0.1, 0.2) * (1.0 + 0.1 * sin(time + uv.y * 10.0));

                // Land: Hellgrün/Braun mit Noise
                vec3 land = vec3(0.2 + 0.3 * n, 0.4 + 0.2 * n, 0.1);

                // Basis-Farbe: Noise > 0.45 = Land, sonst Ozean
                vec3 color = mix(ocean, land, step(0.45, n));

                // Polkappen: Weiß
                if (abs(vPosition.y) > 0.7) color = mix(color, vec3(0.9, 0.95, 1.0), smoothstep(0.7, 0.9, abs(vPosition.y)));

                // Städte: Zufällige helle Punkte (bei Nacht-Seite simulieren)
                float cityNoise = fbm(uv * 20.0);
                if (cityNoise > 0.98) color += vec3(1.0, 0.8, 0.4) * 0.6;

                // Atmosphäre: Blauer Rim-Glow
                float rim = 1.0 - dot(vNormal, vec3(0, 0, 1));
                color += vec3(0.2, 0.5, 1.0) * pow(rim, 2.0) * 0.5;

                // Dynamische Ländereinfärbung (Beispiel: Grün für MX, Rot für hoch Tax – erweitere mit Uniforms)
                if (vUv.x > 0.2 && vUv.x < 0.3 && abs(vUv.y - 0.4) < 0.1) color = mix(color, vec3(0.0, 1.0, 0.0), 0.7); // Grün für Mexiko

                gl_FragColor = vec4(color, 1.0);
            }
        `
    });

    globe = new THREE.Mesh(geometry, material);
    scene.add(globe);
    scene.add(new THREE.AmbientLight(0x404040, 0.4));
    scene.add(new THREE.DirectionalLight(0xffffff, 0.6).position.set(5, 3, 5));

    // Controls: Nur horizontal, Nordpol oben
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enablePan = false;
    controls.enableDamping = true;
    controls.minPolarAngle = Math.PI / 2;
    controls.maxPolarAngle = Math.PI / 2;
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.5;

    // Raycaster für Klicks/Hover
    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();
    const canvas = renderer.domElement;
    canvas.addEventListener('click', onClick);
    canvas.addEventListener('mousemove', onMouseMove);

    animate();
    window.addEventListener('resize', onResize);
}

function onResize() {
    const container = document.getElementById('globe-container');
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

function animate() {
    requestAnimationFrame(animate);
    globe.material.uniforms.time.value += 0.01;
    controls.update();
    renderer.render(scene, camera);
}

function onClick(event) {
    const rect = renderer.domElement.getBoundingClientRect();
    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObject(globe);
    if (intersects.length > 0) {
        const uv = intersects[0].uv; // UV für Land-Detektion (vereinfacht)
        const iso = getIsoFromUv(uv); // Dummy: Mappe zu ISO (z.B. MX bei bestimmten UV)
        showDetails(iso);
    }
}

function onMouseMove(event) {
    controls.autoRotate = false; // Stop bei Hover
    // Hover-Puls: globe.scale.setScalar(1 + 0.05 * Math.sin(Date.now() * 0.01));
}

function getIsoFromUv(uv) {
    // Einfache Mapping (erweitere für echte Ländergrenzen)
    if (uv.x > 0.2 && uv.x < 0.3 && Math.abs(uv.y - 0.4) < 0.1) return 'MX';
    return 'SG'; // Default
}

function updateGlobe() {
    const income = parseInt(document.getElementById('income').value);
    const types = Array.from(document.getElementById('income-types').selectedOptions).map(o => o.value);
    const prefs = Array.from(document.querySelectorAll('#left-panel input[type="checkbox"]:checked')).map(i => i.value);
    document.getElementById('income-value').textContent = income.toLocaleString() + ' €';
    document.getElementById('wealth-value').textContent = parseFloat(document.getElementById('wealth').value).toLocaleString() + ' Mio €';

    // Live Score & Farb-Update (Uniforms erweitern für echte Länder)
    Object.keys(countryData).forEach(iso => {
        const data = countryData[iso];
        let score = 100 - (data.tax.rate * 2) + (data.safety / 2) + (prefs.includes('warm') && data.climate.includes('warm') ? 10 : 0);
        // Farbe: Rot (low) -> Grün (high) – passe Shader-Uniform an
        const colorIntensity = Math.max(0, Math.min(1, score / 100));
        // Hier: Shader-Uniform updaten (z.B. globe.material.uniforms.countryColors.value[... ] = new THREE.Vector3(1 - colorIntensity, colorIntensity, 0));
    });

    gsap.to(globe.rotation, { y: '+=0.5', duration: 1, ease: 'power2.inOut' }); // Sanfte Animation
}

function showDetails(iso) {
    const data = countryData[iso] || countryData['MX']; // Default Mexiko
    const income = parseInt(document.getElementById('income').value);
    const netto = income * (1 - data.tax.rate / 100);
    document.getElementById('netto').textContent = `Netto nach Steuern: ${netto.toLocaleString()} € / Jahr`;
    document.getElementById('netto').className = data.tax.rate < 10 ? 'green' : 'red';
    document.getElementById('living-costs').textContent = `Geschätzte jährliche Lebenshaltungskosten: ${data.costs.totalYear.toLocaleString()} €`;

    let details = `
        <div class="category">
            <h2>${data.name}</h2>
            <p><strong>Steuern:</strong> ${data.tax.rate}% – ${data.tax.special}</p>
        </div>
        <div class="category">
            <h2>Miete & Leben</h2>
            <p>City: ${data.costs.rentCity} € | Außerhalb: ${data.costs.rentOutside || 'N/A'} €</p>
            <canvas id="rentChart" width="200" height="100"></canvas>
        </div>
        <div class="category">
            <h2>Visa</h2>
            <p>${data.visa.type}: ${data.visa.duration}, Min. Einkommen: ${data.visa.minIncome} €</p>
        </div>
        <div class="category">
            <h2>Weiteres</h2>
            <p>Internet: ${data.internet.speed} Mbit | Sicherheit: ${data.safety}/100 | Klima: ${data.climate}</p>
            <p>Expat-Score: ${data.expatScore}/100</p>
            <canvas id="scoreChart" width="200" height="100"></canvas>
        </div>
    `;
    document.getElementById('details').innerHTML = details;
    document.getElementById('right-panel').style.display = 'block';
    gsap.fromTo('#right-panel', { x: 50, opacity: 0 }, { x: 0, opacity: 1, duration: 0.5 });

    // Charts (wie im Bild: Balken rot/grün)
    new Chart(document.getElementById('rentChart'), {
        type: 'bar',
        data: { labels: ['City', 'Außerhalb'], datasets: [{ data: [data.costs.rentCity, data.costs.rentOutside || 0], backgroundColor: ['#ff3366', '#00ff88'] }] },
        options: { scales: { y: { beginAtZero: true, ticks: { color: '#fff' } } }, plugins: { legend: { labels: { color: '#fff' } } } }
    });
    new Chart(document.getElementById('scoreChart'), {
        type: 'doughnut',
        data: { labels: ['Score', 'Rest'], datasets: [{ data: [data.expatScore, 100 - data.expatScore], backgroundColor: ['#00ff88', '#333'] }] },
        options: { plugins: { legend: { labels: { color: '#fff' } } } }
    });
}

// Event Listener
document.getElementById('income').addEventListener('input', (e) => {
    document.getElementById('income-value').textContent = parseInt(e.target.value).toLocaleString() + ' €';
});
document.getElementById('wealth').addEventListener('input', (e) => {
    document.getElementById('wealth-value').textContent = parseFloat(e.target.value).toLocaleString() + ' Mio €';
});

// Start
initGlobe();
updateGlobe(); // Initial Update
</script>
</body>
</html>
